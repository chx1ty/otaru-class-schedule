<!-- 📄 submit.html - 學生填寫表單頁面（支援動態成員與老師端時間設定） -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>導生聚餐填寫表單</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .member-input { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
  </style>
</head>
<body class="container py-4">
  <h1 class="mb-4">導生聚餐 - 小組填寫表單</h1>
  <form id="groupForm">
    <div class="mb-3">
      <label class="form-label">小組名稱</label>
      <input type="text" class="form-control" id="groupName" required />
    </div>
    <div class="mb-3">
      <label class="form-label">組員名單</label>
      <div id="memberList"></div>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addMemberField()">+ 新增組員</button>
    </div>
    <div class="mb-3">
      <label class="form-label">可行時間（老師端設定）</label><br />
      <div id="timeOptions"></div>
    </div>
    <div class="mb-3">
      <label class="form-label">餐廳建議（可填多間）</label>
      <textarea class="form-control" id="restaurants" rows="2"></textarea>
    </div>
    <button type="submit" class="btn btn-primary">送出 / 更新</button>
  </form>
  <p id="statusMsg" class="mt-3 text-success"></p>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_rWFX4gj_no08Q9-iA2iVsmgULfrCu5I",
      authDomain: "otaru-class-schedule.firebaseapp.com",
      projectId: "otaru-class-schedule",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const groupId = urlParams.get("group") || db.collection("groups").doc().id;

    const groupForm = document.getElementById("groupForm");
    const groupName = document.getElementById("groupName");
    const restaurants = document.getElementById("restaurants");
    const memberList = document.getElementById("memberList");
    const timeOptionsDiv = document.getElementById("timeOptions");
    const statusMsg = document.getElementById("statusMsg");

    function addMemberField(value = "") {
      const div = document.createElement("div");
      div.className = "member-input";
      div.innerHTML = `<input type="text" class="form-control member" value="${value}" placeholder="輸入姓名" required />
                       <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.remove()">刪除</button>`;
      memberList.appendChild(div);
    }

    async function loadAvailableTimes() {
      const settingDoc = await db.collection("settings").doc("timeOptions").get();
      if (settingDoc.exists) {
        const options = settingDoc.data().options || [];
        timeOptionsDiv.innerHTML = options.map((opt, i) =>
          `<div class="form-check">
            <input class="form-check-input" type="checkbox" id="time${i}" value="${opt}" />
            <label class="form-check-label" for="time${i}">${opt}</label>
          </div>`
        ).join("");
      }
    }

    async function loadGroupData() {
      const doc = await db.collection("groups").doc(groupId).get();
      if (doc.exists) {
        const data = doc.data();
        groupName.value = data.groupName;
        (data.members || []).forEach(addMemberField);
        restaurants.value = (data.restaurants || []).join("\n");
        const timeInputs = document.querySelectorAll("#timeOptions input");
        (data.timeOptions || []).forEach((t) => {
          const match = [...timeInputs].find((ti) => ti.value === t);
          if (match) match.checked = true;
        });
      } else {
        addMemberField();
      }
    }

    loadAvailableTimes().then(loadGroupData);

    groupForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const memberInputs = [...document.querySelectorAll(".member")].map((input) => input.value.trim()).filter(Boolean);
      const timeSelections = [...document.querySelectorAll("#timeOptions input")].filter((i) => i.checked).map((i) => i.value);
      const data = {
        groupName: groupName.value.trim(),
        members: memberInputs,
        timeOptions: timeSelections,
        restaurants: restaurants.value.split("\n").map((r) => r.trim()).filter(Boolean),
      };
      await db.collection("groups").doc(groupId).set(data);
      statusMsg.innerText = `已儲存！可用以下連結再次修改：\n${window.location.origin}${window.location.pathname}?group=${groupId}`;
    });
  </script>
</body>
</html>
