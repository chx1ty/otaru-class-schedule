<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°ç”Ÿèšé¤å¡«å¯«è¡¨å–®</title>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .member-input, .restaurant-input { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
    #statusMsg.success { color: green; font-weight: bold; animation: fadeIn 0.5s ease-in; white-space: pre-line; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .restaurant-checkbox { margin-bottom: 0.5rem; }
    .custom-restaurant-tag { display: inline-flex; align-items: center; background-color: #f0f0f0; padding: 0.3rem 0.6rem; border-radius: 4px; margin-right: 0.5rem; margin-bottom: 0.5rem; }
    .custom-restaurant-tag button { border: none; background: none; font-size: 0.8rem; margin-left: 0.5rem; cursor: pointer; }
  </style>
</head>
<body class="container py-4">
  <h1 class="mb-4">å°ç”Ÿèšé¤ - å°çµ„å¡«å¯«è¡¨å–®</h1>
  <form id="groupForm">
    <div class="mb-3">
      <label class="form-label">å°çµ„åç¨±</label>
      <input type="text" class="form-control" id="groupName" required />
    </div>
    <div class="mb-3">
      <label class="form-label">çµ„é•· Emailï¼ˆå¯„é€è¡¨å–®é‡æ–°ç·¨è¼¯é€£çµç”¨ï¼‰</label>
      <input type="email" class="form-control" id="leaderEmail" required />
    </div>
    <div class="mb-3">
      <label class="form-label">çµ„å“¡åå–®</label>
      <div id="memberList"></div>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addMemberField()">+ æ–°å¢çµ„å“¡</button>
    </div>
    <div class="mb-3">
      <label class="form-label">å¯è¡Œæ™‚é–“</label>
      <div id="timeOptions"></div>
    </div>
    
    <div class="mb-3">
      <label class="form-label">è¦åƒä»€éº¼ <small class="text-muted">(è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é¤å»³æˆ–è‡ªè¡Œå¡«å¯«)</small></label>
      
      <!-- æ¨è–¦é¤å»³é¸é … -->
      <div class="mb-3">
        <div id="recommendedRestaurants" class="mb-2"></div>
      </div>
      
      <!-- è‡ªè¨‚é¤å»³è¼¸å…¥ -->
      <div class="mb-3">
        <label class="form-label">å¦‚æœä½ æœ‰æƒ³åˆ°è¦åƒä»€éº¼å¯ä»¥è‡ªå·±å¡«â†“â†“â†“</label>
        <div class="input-group mb-2">
          <input type="text" class="form-control" id="customRestaurant" placeholder="è¼¸å…¥æ‚¨å»ºè­°çš„é¤å»³ï¼Œè¼¸å…¥å¾Œè¨˜å¾—æŒ‰ã€Œæ–°å¢ã€!">
          <button class="btn btn-outline-primary" type="button" id="addCustomRestaurant">æ–°å¢</button>
        </div>
        <div id="customRestaurantList"></div>
      </div>
    </div>
    
    <div class="mb-3">
      <label class="form-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
      <textarea class="form-control" id="note" rows="3" placeholder="ä¾‹å¦‚ï¼šæƒ³è·Ÿå°æ¨½èªªçš„è©±ï¼ã€ç‰¹æ®Šéœ€æ±‚ã€æœ‰ç©ºçš„å…¶ä»–æ™‚æ®µç­‰"></textarea>
    </div>
    <button type="submit" class="btn btn-primary" id="submitBtn">é€å‡º / æ›´æ–°</button>
    <button type="button" id="deleteBtn" class="btn btn-danger ms-2 d-none" onclick="deleteGroup()">åˆªé™¤é€™çµ„</button>
  </form>
  <p id="statusMsg" class="mt-3"></p>

  <script>
    emailjs.init("xUjcWEqOVFtcb-BLg");

    const firebaseConfig = {
      apiKey: "AIzaSyA_rWFX4gj_no08Q9-iA2iVsmgULfrCu5I",
      authDomain: "otaru-class-schedule.firebaseapp.com",
      projectId: "otaru-class-schedule",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const groupId = urlParams.get("group") || db.collection("groups").doc().id;

    const groupForm = document.getElementById("groupForm");
    const groupName = document.getElementById("groupName");
    const leaderEmail = document.getElementById("leaderEmail");
    const memberList = document.getElementById("memberList");
    const timeOptionsDiv = document.getElementById("timeOptions");
    const recommendedRestaurantsDiv = document.getElementById("recommendedRestaurants");
    const customRestaurantInput = document.getElementById("customRestaurant");
    const customRestaurantList = document.getElementById("customRestaurantList");
    const noteInput = document.getElementById("note");
    const statusMsg = document.getElementById("statusMsg");
    const deleteBtn = document.getElementById("deleteBtn");
    const submitBtn = document.getElementById("submitBtn");

    function addMemberField(value = "") {
      const div = document.createElement("div");
      div.className = "member-input";
      div.innerHTML = `<input type="text" class="form-control member" value="${value}" placeholder="è¼¸å…¥å§“å" required />
                       <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.remove()">åˆªé™¤</button>`;
      memberList.appendChild(div);
    }

    function addCustomRestaurantTag(value = "") {
      if (!value.trim()) return;
      
      // æª¢æŸ¥æ˜¯å¦é‡è¤‡
      const existingTags = [...customRestaurantList.querySelectorAll(".custom-restaurant-tag span")];
      if (existingTags.some(tag => tag.textContent === value.trim())) return;
      
      const tag = document.createElement("div");
      tag.className = "custom-restaurant-tag";
      tag.innerHTML = `<span>${value.trim()}</span><button type="button">&times;</button>`;
      tag.querySelector("button").addEventListener("click", () => tag.remove());
      customRestaurantList.appendChild(tag);
      customRestaurantInput.value = "";
    }

    document.getElementById("addCustomRestaurant").addEventListener("click", () => {
      addCustomRestaurantTag(customRestaurantInput.value);
    });

    customRestaurantInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addCustomRestaurantTag(customRestaurantInput.value);
      }
    });

    async function loadAvailableTimes() {
      const settingDoc = await db.collection("settings").doc("timeOptions").get();
      if (settingDoc.exists) {
        const options = sortTimeStrings(settingDoc.data().options || []);
        timeOptionsDiv.innerHTML = options.map((opt, i) =>
          `<div class="form-check">
            <input class="form-check-input" type="checkbox" id="time${i}" value="${opt}" />
            <label class="form-check-label" for="time${i}">${opt}</label>
          </div>`
        ).join("");
      }
    }

    async function loadRecommendedRestaurants() {
      const settingDoc = await db.collection("settings").doc("restaurantOptions").get();
      if (settingDoc.exists) {
        const options = settingDoc.data().options || [];
        if (options.length > 0) {
          recommendedRestaurantsDiv.innerHTML = options.map((opt, i) =>
            `<div class="form-check restaurant-checkbox">
              <input class="form-check-input recommended-restaurant" type="checkbox" id="restaurant${i}" value="${opt}" />
              <label class="form-check-label" for="restaurant${i}">${opt}</label>
            </div>`
          ).join("");
        } else {
          recommendedRestaurantsDiv.innerHTML = "<p class='text-muted'>ç›®å‰è€å¸«æ²’æœ‰è¨­å®šæ¨è–¦é¤å»³</p>";
        }
      }
    }

    async function loadGroupData() {
      const doc = await db.collection("groups").doc(groupId).get();
      if (doc.exists) {
        const data = doc.data();
        groupName.value = data.groupName;
        leaderEmail.value = data.leaderEmail || "";
        
        // è¼‰å…¥çµ„å“¡
        (data.members || []).forEach(addMemberField);
        
        // è¼‰å…¥æ™‚é–“é¸é …
        const timeInputs = document.querySelectorAll("#timeOptions input");
        (data.timeOptions || []).forEach(t => {
          const match = [...timeInputs].find(i => i.value === t);
          if (match) match.checked = true;
        });
        
        // è¼‰å…¥æ¨è–¦é¤å»³é¸é …
        const selectedRestaurants = data.selectedRestaurants || [];
        document.querySelectorAll(".recommended-restaurant").forEach(input => {
          if (selectedRestaurants.includes(input.value)) {
            input.checked = true;
          }
        });
        
        // è¼‰å…¥è‡ªè¨‚é¤å»³
        const customRestaurants = data.customRestaurants || [];
        customRestaurants.forEach(restaurant => addCustomRestaurantTag(restaurant));
        
        // å…¼å®¹èˆŠç‰ˆæ•¸æ“šï¼šå¦‚æœæœ‰èˆŠçš„ restaurants æ•¸æ“šä½†æ²’æœ‰ selectedRestaurants æˆ– customRestaurants
        if (data.restaurants && data.restaurants.length > 0 && !data.selectedRestaurants && !data.customRestaurants) {
          data.restaurants.forEach(r => {
            // æª¢æŸ¥æ˜¯å¦ç‚ºæ¨è–¦é¤å»³
            const recommendedInput = [...document.querySelectorAll(".recommended-restaurant")].find(input => input.value === r);
            if (recommendedInput) {
              recommendedInput.checked = true;
            } else {
              addCustomRestaurantTag(r);
            }
          });
        }
        
        noteInput.value = data.note || "";
        deleteBtn.classList.remove("d-none");
      } else {
        addMemberField();
      }
    }

    async function deleteGroup() {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™çµ„å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼")) return;
      await db.collection("groups").doc(groupId).delete();
      statusMsg.innerText = "âŒ å·²åˆªé™¤æ­¤çµ„åˆ¥ã€‚è«‹é‡æ–°æ•´ç†é é¢ã€‚";
      groupForm.querySelectorAll("input, button, textarea").forEach(el => el.disabled = true);
    }

    groupForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      
      const members = [...document.querySelectorAll(".member")].map(i => i.value.trim()).filter(Boolean);
      const selectedRestaurants = [...document.querySelectorAll(".recommended-restaurant:checked")].map(i => i.value);
      const customRestaurants = Array.from(customRestaurantList.children)
        .map(tag => tag.querySelector("span")?.textContent?.trim())
        .filter(Boolean);
      const timeOptions = [...document.querySelectorAll("#timeOptions input:checked")].map(i => i.value);
      const email = leaderEmail.value.trim();
      const groupNameInput = groupName.value.trim();

      // æª¢æŸ¥å¿…å¡«æ¬„ä½
      if (members.length === 0 || timeOptions.length === 0) {
        alert("è«‹å¡«å¯«è‡³å°‘ä¸€ä½çµ„å“¡ï¼Œä¸¦é¸æ“‡ä¸€å€‹å¯è¡Œæ™‚é–“ï¼");
        submitBtn.disabled = false;
        return;
      }

      // æª¢æŸ¥æ˜¯å¦è‡³å°‘é¸æ“‡æˆ–å¡«å¯«ä¸€å€‹é¤å»³
      if (selectedRestaurants.length === 0 && customRestaurants.length === 0) {
        alert("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹æ¨è–¦é¤å»³æˆ–è‡ªè¡Œå¡«å¯«ä¸€å€‹é¤å»³å»ºè­°ï¼");
        submitBtn.disabled = false;
        return;
      }

      const dupSnap = await db.collection("groups").where("groupName", "==", groupNameInput).get();
      const isDuplicate = dupSnap.docs.some(doc => doc.id !== groupId);
      if (isDuplicate) {
        alert("å·²æœ‰å…¶ä»–å°çµ„ä½¿ç”¨ç›¸åŒåç¨±ï¼Œè«‹æ›ä¸€å€‹å°çµ„åç¨±ï¼");
        submitBtn.disabled = false;
        return;
      }

      const data = {
        groupName: groupNameInput,
        leaderEmail: email,
        members,
        selectedRestaurants,  // æ–°å¢ï¼šæ¨è–¦é¤å»³é¸é …
        customRestaurants,    // æ–°å¢ï¼šè‡ªè¨‚é¤å»³
        restaurants: [...selectedRestaurants, ...customRestaurants], // å‘å¾Œå…¼å®¹
        timeOptions,
        note: noteInput.value.trim(),
      };

      await db.collection("groups").doc(groupId).set(data);
      const link = `${window.location.origin}${window.location.pathname}?group=${groupId}`;
      statusMsg.innerText = `âœ… å·²å„²å­˜ï¼ä½ å¯ä»¥ç”¨ä»¥ä¸‹é€£çµå†æ¬¡ç·¨è¼¯æ­¤å°çµ„ï¼š
${link}`;
      statusMsg.className = "success";

      emailjs.send("service_b2n79cs", "template_4r3k9fq", {
        to_email: email,
        group_name: data.groupName,
        edit_url: link,
      }).then(() => {
        statusMsg.innerText += `
ğŸ“© å·²å¯„å‡ºé€šçŸ¥åˆ° ${email}`;
      }).catch(err => {
        statusMsg.innerText += `
âš ï¸ å¯„ä¿¡å¤±æ•—ï¼š${err.text || err}`;
        console.error("EmailJS error:", err);
      });
      
      submitBtn.disabled = false;
    });

    async function initForm() {
      await Promise.all([loadAvailableTimes(), loadRecommendedRestaurants()]);
      await loadGroupData();
    }

    function sortTimeStrings(arr) {
      return arr.sort((a, b) => {
        const isDate = str => /^\d{1,2}\/\d{1,2}\(?.*?\)?/.test(str);
        if (!isDate(a) && isDate(b)) return 1;
        if (isDate(a) && !isDate(b)) return -1;
        if (!isDate(a) && !isDate(b)) return a.localeCompare(b);

        const parse = str => {
          const match = str.match(/(\d{1,2})\/(\d{1,2})\([^)]*\)\s+(\d{1,2}):(\d{2})/);
          if (!match) return Number.MAX_VALUE;
          const [, m, d, h, min] = match.map(Number);
          return new Date(2025, m - 1, d, h, min).getTime();
        };
        return parse(a) - parse(b);
      });
    }
    
    // åˆå§‹åŒ–è¡¨å–®
    initForm();
  </script>
</body>
</html>
