<!-- ğŸ“„ submit.html - EmailJS å¯„ä¿¡ä¿®æ­£ + ç·¨è¼¯æ¨¡å¼ä¹Ÿæª¢æŸ¥å°çµ„åç¨±é‡è¤‡ -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°ç”Ÿèšé¤å¡«å¯«è¡¨å–®</title>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .member-input, .restaurant-input { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
    #statusMsg.success { color: green; font-weight: bold; animation: fadeIn 0.5s ease-in; white-space: pre-line; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body class="container py-4">
  <h1 class="mb-4">å°ç”Ÿèšé¤ - å°çµ„å¡«å¯«è¡¨å–®</h1>
  <form id="groupForm">
    <div class="mb-3">
      <label class="form-label">å°çµ„åç¨±</label>
      <input type="text" class="form-control" id="groupName" required />
    </div>
    <div class="mb-3">
      <label class="form-label">çµ„é•· Emailï¼ˆå¯„é€ç·¨è¼¯é€£çµç”¨ï¼‰</label>
      <input type="email" class="form-control" id="leaderEmail" required />
    </div>
    <div class="mb-3">
      <label class="form-label">çµ„å“¡åå–®</label>
      <div id="memberList"></div>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addMemberField()">+ æ–°å¢çµ„å“¡</button>
    </div>
    <div class="mb-3">
      <label class="form-label">å¯è¡Œæ™‚é–“ï¼ˆç”±è€å¸«è¨­å®šï¼‰</label>
      <div id="timeOptions"></div>
    </div>
    <div class="mb-3">
      <label class="form-label">é¤å»³å»ºè­°</label>
      <div id="restaurantList"></div>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addRestaurantField()">+ æ–°å¢é¤å»³</button>
    </div>
    <button type="submit" class="btn btn-primary" id="submitBtn">é€å‡º / æ›´æ–°</button>
    <button type="button" id="deleteBtn" class="btn btn-danger ms-2 d-none" onclick="deleteGroup()">åˆªé™¤é€™çµ„</button>
  </form>
  <p id="statusMsg" class="mt-3"></p>

  <script>
    emailjs.init("user_fGl3jS65iEKDt3vVa");

const firebaseConfig = {
      apiKey: "AIzaSyA_rWFX4gj_no08Q9-iA2iVsmgULfrCu5I",
      authDomain: "otaru-class-schedule.firebaseapp.com",
      projectId: "otaru-class-schedule",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const groupId = urlParams.get("group") || db.collection("groups").doc().id;

    const groupForm = document.getElementById("groupForm");
    const groupName = document.getElementById("groupName");
    const leaderEmail = document.getElementById("leaderEmail");
    const memberList = document.getElementById("memberList");
    const restaurantList = document.getElementById("restaurantList");
    const timeOptionsDiv = document.getElementById("timeOptions");
    const statusMsg = document.getElementById("statusMsg");
    const deleteBtn = document.getElementById("deleteBtn");
    const submitBtn = document.getElementById("submitBtn");

    function addMemberField(value = "") {
      const div = document.createElement("div");
      div.className = "member-input";
      div.innerHTML = `<input type="text" class="form-control member" value="${value}" placeholder="è¼¸å…¥å§“å" required />
                       <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.remove()">åˆªé™¤</button>`;
      memberList.appendChild(div);
    }

    function addRestaurantField(value = "") {
      const div = document.createElement("div");
      div.className = "restaurant-input";
      div.innerHTML = `<input type="text" class="form-control restaurant" value="${value}" placeholder="å»ºè­°é¤å»³" required />
                       <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.remove()">åˆªé™¤</button>`;
      restaurantList.appendChild(div);
    }

    async function loadAvailableTimes() {
      const doc = await db.collection("settings").doc("timeOptions").get();
      if (doc.exists) {
        const options = doc.data().options || [];
        timeOptionsDiv.innerHTML = options.map((opt, i) =>
          `<div class="form-check">
            <input class="form-check-input" type="checkbox" id="time${i}" value="${opt}" />
            <label class="form-check-label" for="time${i}">${opt}</label>
          </div>`
        ).join("");
      }
    }

    async function loadGroupData() {
      const doc = await db.collection("groups").doc(groupId).get();
      if (doc.exists) {
        const data = doc.data();
        groupName.value = data.groupName;
        leaderEmail.value = data.leaderEmail || "";
        (data.members || []).forEach(addMemberField);
        (data.restaurants || []).forEach(addRestaurantField);
        const timeInputs = document.querySelectorAll("#timeOptions input");
        (data.timeOptions || []).forEach(t => {
          const match = [...timeInputs].find(i => i.value === t);
          if (match) match.checked = true;
        });
        deleteBtn.classList.remove("d-none");
      } else {
        addMemberField();
        addRestaurantField();
      }
    }

    async function deleteGroup() {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™çµ„å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼")) return;
      await db.collection("groups").doc(groupId).delete();
      statusMsg.innerText = "âŒ å·²åˆªé™¤æ­¤çµ„åˆ¥ã€‚è«‹é‡æ–°æ•´ç†é é¢ã€‚";
      groupForm.querySelectorAll("input, button, textarea").forEach(el => el.disabled = true);
    }

    groupForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      const members = [...document.querySelectorAll(".member")].map(i => i.value.trim()).filter(Boolean);
      const restaurants = [...document.querySelectorAll(".restaurant")].map(i => i.value.trim()).filter(Boolean);
      const timeOptions = [...document.querySelectorAll("#timeOptions input")].filter(i => i.checked).map(i => i.value);
      const email = leaderEmail.value.trim();
      const groupNameInput = groupName.value.trim();

      if (members.length === 0 || restaurants.length === 0 || timeOptions.length === 0) {
        alert("è«‹å¡«å¯«è‡³å°‘ä¸€ä½çµ„å“¡ã€å»ºè­°ä¸€é–“é¤å»³ï¼Œä¸¦é¸æ“‡ä¸€å€‹å¯è¡Œæ™‚é–“ï¼");
        submitBtn.disabled = false;
        return;
      }

      const dupSnap = await db.collection("groups").where("groupName", "==", groupNameInput).get();
      const isDuplicate = dupSnap.docs.some(doc => doc.id !== groupId);
      if (isDuplicate) {
        alert("å·²æœ‰å…¶ä»–å°çµ„ä½¿ç”¨ç›¸åŒåç¨±ï¼Œè«‹æ›ä¸€å€‹å°çµ„åç¨±ï¼");
        submitBtn.disabled = false;
        return;
      }

      const data = {
        groupName: groupNameInput,
        leaderEmail: email,
        members,
        restaurants,
        timeOptions,
      };

      await db.collection("groups").doc(groupId).set(data);
      const link = `${window.location.origin}${window.location.pathname}?group=${groupId}`;
      statusMsg.innerText = `âœ… å·²å„²å­˜ï¼ä½ å¯ä»¥ç”¨ä»¥ä¸‹é€£çµå†æ¬¡ç·¨è¼¯æ­¤å°çµ„ï¼š\n${link}`;
      statusMsg.className = "success";

      emailjs.send("service_b2n79cs", "template_4r3k9fq", {
        to_email: email,
        group_name: data.groupName,
        edit_url: link,
      }).then(() => {
        statusMsg.innerText += `\nğŸ“© å·²å¯„å‡ºé€šçŸ¥åˆ° ${email}`;
      }).catch(err => {
        statusMsg.innerText += `\nâš ï¸ å¯„ä¿¡å¤±æ•—ï¼š${err.text || err}`;
        console.error("EmailJS error:", err);
      });
    });

    loadAvailableTimes().then(loadGroupData);
  </script>
</body>
</html>
