<!-- ğŸ“„ submit.html - å®Œæ•´ç‰ˆå« EmailJS å¯„ä¿¡ + åˆªé™¤çµ„åˆ¥åŠŸèƒ½ + é©—è­‰æç¤º + æˆåŠŸå‹•ç•« + å°çµ„åç¨±å”¯ä¸€æ€§æª¢æŸ¥ -->
<!DOCTYPE html>
<html lang="zh-TW">
<head> ...ï¼ˆä¿æŒåŸæœ¬ head å…§å®¹ä¸è®Šï¼‰...
  </script>
</head>
<body class="container py-4">
  ...ï¼ˆä¿ç•™åŸæœ¬ body è¡¨å–®å…§å®¹ä¸è®Šï¼‰...

  <script>
    emailjs.init("fGl3jS65iEKDt3vVa");
    const firebaseConfig = { ... };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const isEditMode = urlParams.get("group") !== null;
    const groupId = urlParams.get("group") || db.collection("groups").doc().id;

    ...ï¼ˆä¿ç•™åŸæœ¬å…ƒç´ ç¶å®šèˆ‡ function å€ï¼‰...

    groupForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      const members = [...document.querySelectorAll(".member")].map(i => i.value.trim()).filter(Boolean);
      const restaurants = [...document.querySelectorAll(".restaurant")].map(i => i.value.trim()).filter(Boolean);
      const timeOptions = [...document.querySelectorAll("#timeOptions input")].filter(i => i.checked).map(i => i.value);
      const email = leaderEmail.value.trim();
      const groupNameInput = groupName.value.trim();

      if (members.length === 0 || restaurants.length === 0 || timeOptions.length === 0) {
        alert("è«‹å¡«å¯«è‡³å°‘ä¸€ä½çµ„å“¡ã€å»ºè­°ä¸€é–“é¤å»³ï¼Œä¸¦é¸æ“‡ä¸€å€‹å¯è¡Œæ™‚é–“ï¼");
        submitBtn.disabled = false;
        return;
      }

      // âœ… æ–°å¢ï¼šæª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒå°çµ„åç¨±
      if (!isEditMode) {
        const dupSnap = await db.collection("groups").where("groupName", "==", groupNameInput).get();
        if (!dupSnap.empty) {
          alert("å·²æœ‰å…¶ä»–å°çµ„ä½¿ç”¨ç›¸åŒåç¨±ï¼Œè«‹æ›ä¸€å€‹å°çµ„åç¨±ï¼");
          submitBtn.disabled = false;
          return;
        }
      }

      const data = {
        groupName: groupNameInput,
        leaderEmail: email,
        members,
        restaurants,
        timeOptions,
      };

      await db.collection("groups").doc(groupId).set(data);
      const link = `${window.location.origin}${window.location.pathname}?group=${groupId}`;
      statusMsg.innerText = `âœ… å·²å„²å­˜ï¼ä½ å¯ä»¥ç”¨ä»¥ä¸‹é€£çµå†æ¬¡ç·¨è¼¯æ­¤å°çµ„ï¼š\n${link}`;
      statusMsg.className = "success";

      await emailjs.send("service_b2n79cs", "template_4r3k9fq", {
        to_email: email,
        group_name: data.groupName,
        edit_url: link,
      }).then(() => {
        statusMsg.innerText += `\nğŸ“© å·²å¯„å‡ºé€šçŸ¥åˆ° ${email}`;
      }).catch(err => {
        statusMsg.innerText += `\nâš ï¸ å¯„ä¿¡å¤±æ•—ï¼š${err.text || err}`;
        console.error("EmailJS error:", err);
      });
    });

    loadAvailableTimes().then(loadGroupData);
  </script>
</body>
</html>
